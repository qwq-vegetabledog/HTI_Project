import os
import torch

class Config:
    # ================= 1. 路径配置 (Paths) =================

    PROJECT_ROOT = r"/home/hti_2025/wei/mywork/"
    BVH_DIR = r"/home/hti_2025/hti_2025/dataset/genea2023_dataset/trn/main-agent/bvh"
    TSV_DIR = r"/home/hti_2025/hti_2025/dataset/genea2023_dataset/trn/main-agent/tsv"
    WAV_DIR = r"/home/hti_2025/hti_2025/dataset/genea2023_dataset/trn/main-agent/wav"

    # LMDB 输出路径
    LMDB_OUTPUT_DIR = r"/home/hti_2025/hti_2025/dataset/genea2023_dataset/trn/main-agent/lmdb"


    # 指向生成的两个文件夹
    LMDB_TRAIN_PATH = os.path.join(LMDB_OUTPUT_DIR, "lmdb_train")
    LMDB_TEST_PATH = os.path.join(LMDB_OUTPUT_DIR, "lmdb_test")

    # ✅ [新增] 标准骨架文件路径
    # 这个文件会在运行 make_lmdb.py 时自动生成
    STANDARD_SKELETON_PATH = os.path.join(LMDB_OUTPUT_DIR, "standard_skeleton.pkl")

    # 1.3 模型保存路径
    SAVE_DIR = r"/home/hti_2025/wei/mywork/checkpoints"
    LOG_DIR = r"/home/hti_2025/wei/mywork/logs"
    
    EVAL_INTERVAL = 5     # ✅ 每隔多少轮验证一次
    SAVE_BEST_ONLY = True # ✅ 是否只保存验证集损失最低的模型

    
    # ================= 2. 数据预处理参数 (Data Preprocessing) =================
    # 18个上半身关键关节
    TARGET_JOINTS = [
        'b_spine0', 'b_spine1', 'b_spine2', 'b_spine3', 
        'b_l_shoulder', 'b_l_arm', 'b_l_arm_twist', 'b_l_forearm', 'b_l_wrist_twist', 'b_l_wrist', 
        'b_r_shoulder', 'b_r_arm', 'b_r_arm_twist', 'b_r_forearm', 'b_r_wrist_twist', 'b_r_wrist', 
        'b_neck0', 'b_head'
    ]

    DATA_MEAN = [0.00000, 2.52148, -2.91992, 0.99905, -0.00368, -0.00004, 0.00367, 0.99811, -0.03582, 0.00016, 0.03565, 0.99905, 0.00000, 10.87292, 2.18686, 0.99885, -0.00300, 0.00380, 0.00311, 0.98429, -0.13923, -0.00336, 0.13912, 0.98510, 0.00000, 10.35744, -4.27542, 0.99541, -0.00352, 0.01147, 0.00281, 0.99639, 0.03290, -0.01154, -0.03433, 0.99701, 0.00000, 18.39572, -1.77432, 0.99891, -0.00309, 0.00331, 0.00308, 0.99904, 0.00169, -0.00332, -0.00161, 0.99992, 2.80078, 7.18359, 9.08594, 0.99028, -0.02621, 0.02628, 0.02476, 0.99217, 0.02483, -0.03033, -0.02273, 0.99319, 0.34174, -4.19341, -0.48400, 0.17237, 0.61431, -0.75509, -0.95477, 0.20768, -0.05581, 0.12358, 0.74362, 0.63880, 0.00000, 0.00000, 0.00000, 0.99979, 0.00576, -0.01365, -0.01435, 0.81464, -0.37347, 0.00368, 0.37371, 0.81467, 25.57812, -0.59326, -0.68848, 0.64250, -0.45242, -0.27863, 0.44843, 0.74302, -0.16634, 0.28500, -0.15517, 0.89939, 24.78125, -0.57471, -0.66699, 0.99772, -0.01206, 0.02785, -0.02666, 0.82048, 0.19966, -0.01583, -0.20096, 0.81858, 2.06055, 0.07483, 1.81543, 0.91528, 0.02986, -0.02587, -0.02754, 0.93302, 0.05441, 0.02672, -0.00714, 0.97691, -2.80078, 7.18359, 9.08594, 0.98434, 0.04142, -0.06082, -0.02975, 0.98309, 0.08600, 0.07544, -0.07758, 0.98404, -0.41247, -4.13262, -0.50146, 0.09655, -0.30960, 0.93288, 0.96330, 0.14588, -0.05797, -0.12173, 0.92282, 0.32566, 0.00000, 0.00000, 0.00000, 0.99985, -0.00087, 0.00808, 0.00801, 0.87259, -0.16877, -0.00139, 0.16896, 0.87258, -25.57812, -0.71777, -0.67236, 0.67703, 0.44027, 0.08231, -0.43769, 0.68956, -0.07173, -0.09511, -0.05363, 0.98721, -24.78125, -0.69531, -0.65137, 0.99583, 0.01535, -0.06966, 0.05612, 0.61203, 0.57107, 0.03382, -0.57439, 0.60961, -1.98047, -0.26611, 1.88672, 0.92499, -0.02528, 0.06782, 0.03620, 0.91911, -0.16178, -0.04337, 0.17238, 0.97081, 0.00000, 12.78031, 3.30138, 0.98880, -0.01725, -0.00866, 0.01608, 0.97263, -0.05941, 0.00984, 0.05004, 0.97846, 0.00000, 6.35003, 3.18870, 0.98296, 0.00241, -0.01170, -0.00897, 0.98207, 0.01872, 0.01064, -0.01308, 0.96626]
    DATA_STD = [0.00000, 0.00000, 0.00000, 0.00110, 0.04350, 0.00330, 0.04333, 0.00160, 0.02492, 0.00499, 0.02488, 0.00114, 0.00000, 0.09724, 0.00623, 0.00132, 0.04431, 0.01833, 0.04380, 0.01753, 0.09774, 0.01958, 0.09768, 0.01750, 0.00000, 0.09542, 0.01878, 0.00751, 0.07170, 0.06186, 0.07223, 0.00293, 0.02990, 0.06128, 0.02947, 0.00684, 0.00000, 0.10409, 0.02030, 0.00123, 0.04405, 0.01559, 0.04405, 0.00111, 0.00176, 0.01561, 0.00162, 0.00049, 0.00000, 0.00000, 0.00000, 0.01853, 0.09983, 0.08757, 0.09682, 0.02330, 0.06684, 0.09003, 0.06244, 0.01159, 0.37794, 0.21330, 0.19981, 0.13856, 0.04857, 0.03447, 0.06232, 0.15041, 0.12514, 0.14264, 0.03926, 0.04248, 0.00000, 0.00000, 0.00000, 0.00035, 0.00672, 0.01424, 0.01471, 0.24872, 0.36689, 0.00561, 0.36713, 0.24867, 0.00000, 0.00000, 0.00000, 0.46729, 0.25174, 0.15225, 0.24701, 0.33587, 0.21292, 0.15981, 0.20731, 0.13151, 0.00000, 0.00000, 0.00000, 0.00304, 0.02177, 0.05635, 0.03655, 0.23717, 0.47819, 0.04768, 0.47914, 0.23967, 0.00000, 0.00000, 0.00000, 0.17240, 0.32245, 0.16435, 0.29998, 0.14993, 0.11529, 0.20270, 0.04560, 0.04149, 0.00000, 0.00000, 0.00000, 0.02943, 0.12842, 0.09118, 0.11034, 0.03975, 0.10722, 0.10709, 0.08791, 0.02788, 0.45022, 0.18199, 0.01143, 0.14653, 0.04788, 0.02825, 0.06037, 0.16320, 0.13087, 0.15097, 0.04848, 0.04891, 0.00000, 0.00000, 0.00000, 0.00033, 0.00908, 0.01509, 0.01467, 0.20154, 0.41138, 0.00974, 0.41153, 0.20155, 0.00000, 0.00000, 0.00000, 0.47456, 0.33520, 0.05885, 0.33174, 0.45614, 0.09842, 0.07601, 0.08586, 0.01880, 0.00000, 0.00000, 0.00000, 0.00460, 0.02436, 0.05139, 0.05770, 0.40108, 0.36325, 0.02645, 0.36577, 0.40350, 0.00000, 0.00000, 0.00000, 0.14279, 0.31908, 0.13017, 0.31603, 0.13741, 0.09485, 0.14468, 0.06468, 0.02872, 0.00000, 0.08581, 0.01694, 0.01793, 0.13136, 0.06596, 0.12412, 0.02473, 0.18489, 0.07886, 0.18254, 0.02184, 0.00000, 0.07835, 0.03933, 0.03010, 0.03659, 0.17730, 0.03991, 0.01425, 0.18262, 0.17643, 0.18401, 0.03291]
    

    # 目标帧率
    FPS = 30
    
    # 训练/测试集划分比例 (0.9 表示 90% 训练, 10% 测试)
    TRAIN_RATIO = 0.9

    # 动作切片长度 (4秒 * 30fps = 120帧)
    WINDOW_FRAMES = 120 
    
    # 文本最大长度 (Token数量)
    MAX_TEXT_LEN = 32

    # 【重要】输入特征维度
    # 计算: 18关节 * (3位置 + 6旋转 + 3速度 + 6旋转速度) = 18 * 18 = 324
    # INPUT_FEATS = 324 

    INPUT_FEATS = 216


    # ================= 3. 模型架构 (Model Architecture) =================
    # Transformer 层数
    LAYERS = 8
    
    # 注意力头数
    HEADS = 8
    
    # 隐层维度 (Latent Size)
    LATENT_DIM = 512
    
    # BERT 文本特征维度 (固定)
    TEXT_DIM = 768
    
    # Dropout 概率
    DROPOUT = 0.1
    
    # 激活函数
    ACTIVATION = "gelu"

    # ================= 4. Diffusion 参数 (Diffusion Process) =================
    # 扩散总步数
    DIFFUSION_STEPS = 1000
    
    # 噪声调度策略
    BETA_SCHEDULE = "cosine"
    
    # 损失函数类型
    LOSS_TYPE = "l2"

    # ================= 5. 训练超参数 (Training Hyperparams) =================
    BATCH_SIZE = 64

    # ================= 断点续训配置 =================
    # 如果是 None，则从头开始训练
    # 如果是路径字符串 (例如 r"F:\...\model_epoch_50.pt")，则加载该权重继续训练
    RESUME_CHECKPOINT = "/home/hti_2025/wei/mywork/checkpoints/model_epoch_600.pt"
    
    # 训练轮数
    EPOCHS = 2000
    
    # 学习率
    LR = 1e-4  # 0.0001
    
    # 权重衰减
    WEIGHT_DECAY = 1e-4
    
    # 梯度裁剪
    GRAD_CLIP = 1.0
    
    # 每隔多少 Epoch 保存一次
    SAVE_INTERVAL = 50
    
    # DataLoader 线程数 (Windows设为0)
    NUM_WORKERS = 0
    
    # 模型保存路径
    SAVE_DIR = os.path.join(PROJECT_ROOT, "checkpoints")
    LOG_DIR = os.path.join(PROJECT_ROOT, "logs")

    # ================= 6. 硬件设置 (Device) =================
    DEVICE = "cuda" if torch.cuda.is_available() else "cpu"

    